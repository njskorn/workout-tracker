<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Logger</title>
    <style>
        body {
            font-family: Arial, sans-serif; 
            margin: 20px auto; 
            max-width: 800px;
            padding: 20 px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block; 
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #message {
            margin-top: 20px; 
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda; 
            color: #155724; 
        }
        .error {
            background-color: #f8d7da; 
            color: #721c24; 
        }

        /* Sets table layout */
        .sets-container {
            margin-top: 15px;
        }

        .sets-header {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 1fr 1fr 80px;
            gap: 8px;
            padding: 8px 0;
            font-weight: bold;
            border-bottom: 2px solid #333;
            margin-bottom: 10px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 1fr 1fr 80px;
            gap: 8px;
            padding: 8px 0;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .set-label-col {
            text-align: center;
            font-weight: bold;
        }

        .input-col {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }

        .action-col {
            text-align: center;
        }

        .action-col button {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        /* Hide mobile labels on desktop */
        .mobile-label {
            display: none;
        }

        .input-group {
            /* On desktop, this doesn't affect grid layout */
        }

        @media (max-width: 768px) {
            /* Add padding to page */
            body {
                padding: 15px;
            }
            
            /* Hide column headers on mobile */
            .sets-header {
                display: none;
            }
            
            /* Stack sets vertically */
            .set-row {
                display: block;
                padding: 15px;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: #f9f9f9;
            }
            
            /* Set label: "Set 1" */
            .set-label-col::before {
                content: "Set ";
            }
            
            .set-label-col {
                display: block;
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 15px;
                text-align: left;
            }
            
            /* Input groups: label and input side-by-side */
            .input-group {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
                gap: 10px;
            }
            
            .mobile-label {
                display: block;
                font-weight: bold;
                font-size: 14px;
                min-width: 110px; /* Keep labels aligned */
                flex-shrink: 0; /* Don't let label shrink */
            }
            
            .input-col {
                flex: 1; /* Input takes remaining space */
                padding: 10px;
                font-size: 16px;
            }
            
            /* Remove button full width */
            .action-col button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <h1>Workout Logger</h1>
    <form id="workoutForm">
        <div class="form-group">
            <label for="user_id">User ID:</label>
            <select id="user_id" required>
                <option value="">Select User</option>
                <option value="Nettle">Nettle</option>
                <option value="Eric">Eric</option>
            </select>
        </div>

        <div class="form-group">
            <label for="workoutDate">Date:</label>
            <input type="date" id="workoutDate" required>
        </div>
        
        <!-- Container for all exercises-->
        <div id="exercisesContainer">
            <!-- Single exercise (will be duplicated) -->
            <div class="exercise-block">
                <h3>Exercise 1</h3>

                <div class="form-group">
                    <label>Equipment:</label>
                    <select class="equipment" required>
                        <option value="">Select Equipment</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="kettlebell">Kettlebell</option>
                        <option value="machine">Machine</option>
                        <option value="bodyweight">Bodyweight</option>
                        <option value="cable">Cable</option>
                        <option value="band">Band</option>
                        <option value="exercise ball">Exercise Ball</option>
                        <option value="foam roll">Foam Roll</option>
                        <option value="medicine ball">Medicine Ball</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Exercise Name:</label>
                    <input
                        type="text"
                        class="exercise-name"
                        list="exerciseList"
                        placeholder="Start typing an exercise name..."
                        required
                    >
                </div>

                <div class="sets-container">
                    <!-- Column headers (always visible) -->
                    <div class="sets-header">
                        <span class="set-label-col">Set</span>
                        <span class="input-col">Goal Reps</span>
                        <span class="input-col">Goal Weight</span>
                        <span class="input-col">Actual Reps</span>
                        <span class="input-col">Actual Weight</span>
                        <span class="action-col"></span> <!-- For remove button -->
                    </div>
                    
                    <!-- First set -->
                    <div class="set-row">
                        <label class="set-label-col">1</label>
                        
                        <div class="input-group">
                            <label class="mobile-label">Goal Reps:</label>
                            <input type="number" class="input-col set-goal-reps" min="0">
                        </div>
                        
                        <div class="input-group">
                            <label class="mobile-label">Goal Weight:</label>
                            <input type="number" class="input-col set-goal-weight" min="0" step="0.5">
                        </div>
                        
                        <div class="input-group">
                            <label class="mobile-label">Actual Reps:</label>
                            <input type="number" class="input-col set-reps" min="0" required>
                        </div>
                        
                        <div class="input-group">
                            <label class="mobile-label">Actual Weight:</label>
                            <input type="number" class="input-col set-weight" min="0" step="0.5" required>
                        </div>
                        
                        <span class="action-col"></span>
                    </div>
                </div>

                <!-- Add set button -->
                <button type="button" class="add-set-btn" onclick="addSet(this)">+ Add Set</button>
            </div>
        </div>

        <!-- Add exercise button -->
        <button type="button" onclick="addExercise()">+ Add Exercise</button>

        <button type="submit">Log Workout</button>

    </form>
    <datalist id="exerciseList">
    <!-- Options will be populated by javascript -->
    </datalist>
    
    <div id="message"></div>

    <script>
        // global variable to store exercises
        let exerciseData = null;

        // populate exercise datalist
        // first fetch exercises from API
        document.addEventListener('DOMContentLoaded', async function() {
            // 'DOMContentLoaded' executes this event when HTML is fully loaded
            // async allows us to use await

            // set today's date as default
            document.getElementById('workoutDate').valueAsDate = new Date();

            // fetch exercises from API
            try {
                // await: wait for this to compelte before continuing
                const response = await fetch('http://localhost:8000/exercises');

                // Check request
                if (!response.ok) {
                    throw new Error('Failed to fetch exercises');
                }

                //parse JSON response into JS array
                const exercises = await response.json();

                // save to global variable
                exerciseData = exercises;

                // get the datalist element from HTML
                const datalist = document.getElementById('exerciseList');

                // loop through exercises and add them as options
                exercises.forEach(exercise => {
                    // create option element
                    const option = document.createElement('option');
                    // set value to exercise name
                    option.value = exercise.name;
                    // append option to datalist
                    datalist.appendChild(option);
                });

                // log success o console
                console.log(`Exercises ${exercises.length} loaded successfully`);
            } catch (error) {
                // log error to console
                console.error('Error fetching exercises:', error);
                alert('Could not load exercises. Please refresh the page.');
            }
        });

        // listen for when the user selects an exercise from the dropdown
        // update: listen for any changes in any exercise name
        // run whenever the exercise name input changes
        document.addEventListener('input', async function(event) {
            // check if the changed element is an exercise name input
            // `event.target` is the element that triggered the event
            if (event.target.classList.contains('exercise-name')) {
                // get selected exercise name
                const selectedExerciseName = event.target.value;

                // catch if exercises are not loaded
                if (!exerciseData) {
                    return;
                }

                // find the exercise in the database
                const selectedExercise = exerciseData.find(ex => ex.name === selectedExerciseName);

                // Part 1: Auto-fill equipment
                // if we have a match and it has equipment info
                if (selectedExercise && selectedExercise.equipment) {
                    // 'event.target.closest()' finds the nearest parent with that class
                    const exerciseBlock = event.target.closest('.exercise-block');
                    // get the equipment dropdown element
                    const equipmentDropdown = exerciseBlock.querySelector('.equipment');

                    // map database equipment to dropdown value
                    const equipmentMap = {
                        'body only': 'bodyweight',    // Database → Our schema
                        'kettlebells': 'kettlebell',  // plural → singular
                        'bands': 'band',               // plural → singular
                        'e-z curl bar': 'barbell'    // treat as barbell
                    };

                    // get equipement from database
                    let equipmentValue = selectedExercise.equipment;

                    // using mapping if available
                    if (equipmentMap[equipmentValue]) {
                        equipmentValue = equipmentMap[equipmentValue];
                    }

                    // set the dropdown to the correct equipment if it exists
                    const validOptions = Array.from(equipmentDropdown.options).map(opt => opt.value);
                    if (validOptions.includes(equipmentValue)) {
                        equipmentDropdown.value = equipmentValue;
                    }

                    // log 
                    console.log(`Auto-filled equipment: ${equipmentValue} for ${selectedExerciseName}`);
                
                    // Part 2: Fetch last performance and pre-fill goals
            
                    // Get the user_id from the form
                    // We need this to look up their workout history
                    const userId = document.getElementById('user_id').value;
                    
                    // Only fetch history if user has been selected
                    if (!userId) {
                        console.log('Select user first before loading goals');
                        return;
                    }
                    
                    try {
                        // Encode exercise name for URL
                        // Spaces become %20, special characters are escaped
                        const encodedExerciseName = encodeURIComponent(selectedExerciseName);
                        
                        // Call our API to get last time this user did this exercise
                        const response = await fetch(`http://localhost:8000/exercises/${userId}/${encodedExerciseName}/last`);
                        const data = await response.json();
                        
                        // Check if we found a previous workout
                        if (data.found) {
                            console.log(`Found last workout for ${selectedExerciseName} on ${data.workout_date}`);
                            
                            // Get the sets container for THIS exercise block
                            const setsContainer = exerciseBlock.querySelector('.sets-container');
                            
                            // Clear any existing sets
                            setsContainer.innerHTML = '';
                            
                            // Get the sets from last workout
                            const lastSets = data.exercise.sets;
                            
                            // Create a set for each set they did last time
                            lastSets.forEach((lastSet, index) => {
                                // Create new set div
                                const setDiv = document.createElement('div');
                                setDiv.className = 'set-row';
                                
                                // Use last workout's GOAL as this workout's GOAL
                                // If they didn't have a goal last time, use their actual as starting point
                                const goalReps = lastSet.goal_reps || lastSet.reps;
                                const goalWeight = lastSet.goal_weight_lbs || lastSet.weight_lbs;
                                
                                // Build the HTML for this set
                                // Goals are pre-filled, actuals are empty (user will enter them)
                                setDiv.innerHTML = `
                                    <label class="set-label-col">${index + 1}</label>
                                    
                                    <div class="input-group">
                                        <label class="mobile-label">Goal Reps:</label>
                                        <input type="number" class="input-col set-goal-reps" min="0" value="${goalReps}">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="mobile-label">Goal Weight:</label>
                                        <input type="number" class="input-col set-goal-weight" min="0" step="0.5" value="${goalWeight}">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="mobile-label">Actual Reps:</label>
                                        <input type="number" class="input-col set-reps" min="0" required>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="mobile-label">Actual Weight:</label>
                                        <input type="number" class="input-col set-weight" min="0" step="0.5" required>
                                    </div>
                                    
                                    ${index > 0 ? '<button type="button" class="action-col" onclick="removeSet(this)" style="background-color: #f44336;">Remove</button>' : '<span class="action-col"></span>'}
                                `;
                                
                                // Add this set to the container
                                setsContainer.appendChild(setDiv);
                            });
                            
                            // Update the set counter for this exercise
                            // So "Add Set" knows how many we have
                            setCounts.set(exerciseBlock, lastSets.length);
                            
                            console.log(`Pre-filled ${lastSets.length} sets with goals from last workout`);
                            
                        } else {
                            // No previous workout found - that's okay!
                            // User will just fill in manually for first time
                            console.log(`No previous workout found for ${selectedExerciseName} - first time doing this exercise!`);
                        }
                        
                    } catch (error) {
                        // Something went wrong with the fetch
                        console.error('Error fetching last workout:', error);
                    }
                }
            }
        });

        // Track set counts for each exercise separately
        // use a map to store: exerciseBlock → setCount
        const setCounts = new Map();

        function addSet(button){
            // 'button' = the "Add Set" button that was clicked
            // Find which exercise block this button belongs to
            const exerciseBlock = button.closest('.exercise-block');
            // Get or initialize current set count
            let setCount = setCounts.get(exerciseBlock) || 1;

            // increment set count
            setCount++;
            setCounts.set(exerciseBlock, setCount);

            // Find the sets container within THIS exercise block
            const setsContainer = exerciseBlock.querySelector('.sets-container');
            
            // Create new set div
            const setDiv = document.createElement('div');
            setDiv.className = 'set-row';
            setDiv.innerHTML = `
                    <label class="set-label-col">${setCount}</label>
    
                    <div class="input-group">
                        <label class="mobile-label">Goal Reps:</label>
                        <input type="number" class="input-col set-goal-reps" min="0">
                    </div>
                    <div class="input-group">
                        <label class="mobile-label">Goal Weight:</label>
                        <input type="number" class="input-col set-goal-weight" min="0" step="0.5">
                    </div>
                    <div class="input-group">
                        <label class="mobile-label">Actual Reps:</label>
                        <input type="number" class="input-col set-reps" min="0" required>
                    </div>
                    <div class="input-group">
                        <label class="mobile-label">Actual Weight:</label>
                        <input type="number" class="input-col set-weight" min="0" step="0.5" required>
                    </div>
                    
                    <button type="button" class="action-col" onclick="removeSet(this)" style="background-color: #f44336;">Remove</button>
            `;
            setsContainer.appendChild(setDiv);
        }

        function removeSet(button) {
            // Find the exercise block
            const exerciseBlock = button.closest('.exercise-block');
            
            // Get current set count
            let setCount = setCounts.get(exerciseBlock) || 1;
            
            // Only remove if more than 1 set
            if (setCount > 1) {
                // Remove the set div
                button.parentElement.remove();
                
                // Decrement count
                setCount--;
                setCounts.set(exerciseBlock, setCount);
                
                // Renumber remaining sets in THIS exercise
                const setInputs = exerciseBlock.querySelectorAll('.set-inputs');
                setInputs.forEach((setDiv, index) => {
                    setDiv.querySelector('label').textContent = `Set ${index + 1}:`;
                });
            }
        }

        // track how many exercises we have
        let exerciseCount = 1;

        function addExercise() {
            exerciseCount++;

            // get exercise container
            const exercisesContainer = document.getElementById('exercisesContainer');

            // Create a new exercise block (copy structure from first one)
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-block';
            
            // Build the HTML for the new exercise
            exerciseDiv.innerHTML = `
                <h3>Exercise ${exerciseCount}</h3>

                <div class="form-group">
                    <label>Equipment:</label>
                    <select class="equipment" required>
                        <option value="">Select Equipment</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="kettlebell">Kettlebell</option>
                        <option value="machine">Machine</option>
                        <option value="bodyweight">Bodyweight</option>
                        <option value="cable">Cable</option>
                        <option value="band">Band</option>
                        <option value="exercise ball">Exercise Ball</option>
                        <option value="foam roll">Foam Roll</option>
                        <option value="medicine ball">Medicine Ball</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Exercise Name:</label>
                    <input
                        type="text"
                        class="exercise-name"
                        list="exerciseList"
                        placeholder="Start typing an exercise name..."
                        required
                    >
                </div>

                <div class="sets-container">
                    <div class="sets-header">
                        <span class="set-label-col">Set</span>
                        <span class="input-col">Goal Reps</span>
                        <span class="input-col">Goal Weight</span>
                        <span class="input-col">Actual Reps</span>
                        <span class="input-col">Actual Weight</span>
                        <span class="action-col"></span> <!-- For remove button -->
                    </div>
                    
                    <div class="set-row">
                        <label class="set-label-col">1</label>
    
                        <div class="input-group">
                            <label class="mobile-label">Goal Reps:</label>
                            <input type="number" class="input-col set-goal-reps" min="0">
                        </div>
                        <div class="input-group">
                            <label class="mobile-label">Goal Weight:</label>
                            <input type="number" class="input-col set-goal-weight" min="0" step="0.5">
                        </div>
                        <div class="input-group">
                            <label class="mobile-label">Actual Reps:</label>
                            <input type="number" class="input-col set-reps" min="0" required>
                        </div>
                        <div class="input-group">
                            <label class="mobile-label">Actual Weight:</label>
                            <input type="number" class="input-col set-weight" min="0" step="0.5" required>
                        </div>
                        
                        <span class="action-col"></span> <!-- First set has no remove button -->
                    </div>
                </div>

                <button type="button" class="add-set-btn" onclick="addSet(this)">+ Add Set</button>
                <button type="button" onclick="removeExercise(this)" style="background-color: #f44336; margin-top: 10px;">Remove Exercise</button>
            `;
            
            // Add the new exercise to the container
            exercisesContainer.appendChild(exerciseDiv);
            
            console.log(`Added Exercise ${exerciseCount}`);
        }

        function removeExercise(button) {
            // Only allow removal if more than 1 exercise
            if (exerciseCount > 1) {
                // Remove the exercise block
                button.closest('.exercise-block').remove();
                
                // Decrement counter
                exerciseCount--;
                
                // Renumber remaining exercises
                const exerciseBlocks = document.querySelectorAll('.exercise-block');
                exerciseBlocks.forEach((block, index) => {
                    block.querySelector('h3').textContent = `Exercise ${index + 1}`;
                });
                
                console.log(`Removed exercise. Now have ${exerciseCount} exercises.`);
            }
        }


        // handle form submission
        document.getElementById('workoutForm').addEventListener('submit', async (e) => {
            // prevent default form submission (which would reload the page)
            e.preventDefault();
            
            // get the simple fields (same as before)
            const workoutDate = document.getElementById('workoutDate').value;
            const userId = document.getElementById('user_id').value;
            
            // get all exercise blocks from the page
            // querySelectorAll returns a NodeList (similar to a list in Python)
            const exerciseBlocks = document.querySelectorAll('.exercise-block');
            
            // loop through each exercise block and extract data
            // Array.from() converts NodeList to Array so we can use .map()
            const exercises = Array.from(exerciseBlocks).map(block => {
                // For each exercise block, extract:
                
                // exercise name
                const name = block.querySelector('.exercise-name').value;
                
                // equipment
                const equipment = block.querySelector('.equipment').value;
                
                // get all sets within THIS exercise block
                const setInputs = block.querySelectorAll('.set-row');
                
                // loop through each set and extract reps/weight
                const sets = Array.from(setInputs).map(setDiv => {
                    // get the two input fields within this set
                    const reps = parseInt(setDiv.querySelector('.set-reps').value);
                    const weight = parseFloat(setDiv.querySelector('.set-weight').value);
                    const goalReps = setDiv.querySelector('.set-goal-reps').value;
                    const goalWeight = setDiv.querySelector('.set-goal-weight').value;
                    
                    // return set object (matches our Pydantic schema)
                    return {
                        reps: reps,
                        weight_lbs: weight,
                        goal_reps: goalReps ? parseInt(goalReps) : null,
                        goal_weight_lbs: goalWeight ? parseFloat(goalWeight) : null
                    };
                });
                
                // return exercise object (matches our Pydantic schema)
                return {
                    name: name,
                    equipment: equipment,
                    sets: sets
                };
            });
            
            // build the complete workout object
            const workout = {
                workout_date: workoutDate,
                user_id: userId,
                exercises: exercises  // Now an ARRAY of exercises containing array of sets
            };
            
            // log it so we can see what we're sending (helpful for debugging)
            console.log('Sending workout:', JSON.stringify(workout, null, 2));
            
            // send to API
            try {
                const response = await fetch('http://localhost:8000/workouts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workout)
                });
                
                const data = await response.json();
                
                // show success message
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'success';
                messageDiv.textContent = `Workout Logged Successfully! ${data.exercises} exercise(s), Total Volume: ${data.total_volume} lbs`;
                
                // clear the form
                document.getElementById('workoutForm').reset();
                document.getElementById('workoutDate').valueAsDate = new Date();
                
                // reset to single exercise
                document.getElementById('exercisesContainer').innerHTML = `
                    <div class="exercise-block">
                        <h3>Exercise 1</h3>
                        <div class="form-group">
                            <label>Exercise Name:</label>
                            <input type="text" class="exercise-name" list="exerciseList" placeholder="Start typing an exercise name..." required>
                        </div>
                        <div class="form-group">
                            <label>Equipment:</label>
                            <select class="equipment" required>
                                <option value="">Select Equipment</option>
                                <option value="barbell">Barbell</option>
                                <option value="dumbbell">Dumbbell</option>
                                <option value="kettlebell">Kettlebell</option>
                                <option value="machine">Machine</option>
                                <option value="bodyweight">Bodyweight</option>
                                <option value="cable">Cable</option>
                                <option value="band">Band</option>
                                <option value="exercise ball">Exercise Ball</option>
                                <option value="foam roll">Foam Roll</option>
                                <option value="medicine ball">Medicine Ball</option>
                            </select>
                        </div>
                        <div class="sets-container">
                            <div class="form-group set-inputs">
                                <label>Set 1:</label>
                                <input type="number" placeholder="Reps" min="1" class="set-reps" required>
                                <input type="number" placeholder="Weight (lbs)" min="0" step="0.5" class="set-weight" required>
                            </div>
                        </div>
                        <button type="button" class="add-set-btn" onclick="addSet(this)">+ Add Set</button>
                    </div>
                `;
                exerciseCount = 1;
                
            } catch (error) {
                // show error message
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'error';
                messageDiv.textContent = "Error logging workout: " + error.message;
            }
        });
    </script>
</body>
</html>